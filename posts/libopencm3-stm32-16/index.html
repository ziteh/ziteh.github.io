<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width">
<meta name="theme-color" content="#222"><meta name="generator" content="Hexo 7.2.0">

  <link rel="apple-touch-icon" sizes="180x180" href="/uploads/apple-touch-icon.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/uploads/favicon-32x32.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/uploads/favicon-16x16.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">
  <link rel="manifest" href="/uploads/site.webmanifest">

<link rel="stylesheet" href="/css/main.css">

<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Noto+Sans:300,300italic,400,400italic,700,700italic%7CNoto+Sans+TC:300,300italic,400,400italic,700,700italic%7CFira+Mono:300,300italic,400,400italic,700,700italic&display=swap&subset=latin,latin-ext">

<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" integrity="sha256-XOqroi11tY4EFQMR9ZYwZWKj5ZXiftSx36RRuC3anlA=" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/fancyapps-ui/5.0.31/fancybox/fancybox.css" integrity="sha256-gkQVf8UKZgQ0HyuxL/VnacadJ+D2Kox2TCEBuNQg5+w=" crossorigin="anonymous">

<script class="next-config" data-name="main" type="application/json">{"hostname":"ziteh.github.io","root":"/","images":"/images","scheme":"Pisces","darkmode":false,"version":"8.20.0","exturl":false,"sidebar":{"position":"right","width_expanded":320,"width_dual_column":240,"display":"post","padding":18,"offset":12},"hljswrap":true,"copycode":{"enable":true,"style":"flat"},"fold":{"enable":false,"height":500},"bookmark":{"enable":false,"color":"#222","save":"auto"},"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":"disqus","storage":true,"lazyload":true,"nav":{"disqus":{"text":"Load Disqus","order":-1}},"activeClass":"disqus"},"stickytabs":false,"motion":{"enable":false,"async":false,"transition":{"menu_item":"fadeInDown","post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"i18n":{"placeholder":"搜尋...","empty":"我們無法找到任何有關 ${query} 的搜索結果","hits_time":"${hits} 找到 ${time} 個結果","hits":"找到 ${hits} 個結果"}}</script><script src="/js/config.js"></script>

    <meta name="description" content="前言看門狗計時器（Watchdog timer，WDG）是眾多 MCU 都有的功能，它是一種特殊功能的計時器，其功能爲不斷下數，如果下數到一個值之前都沒有做刷新（Refresh）的話就認定目前系統出問題了（例如進入死迴圈跳不出來），並自動觸發系統重置（System reset）。如果要系統正常運作不 Reset 的話，必須要在 WDG Timeout 前進行 Refresh，以告訴 WDG：「我還">
<meta property="og:type" content="article">
<meta property="og:title" content="STM32 LibOpenCM3：IWDG 獨立看門狗計時器">
<meta property="og:url" content="https://ziteh.github.io/posts/libopencm3-stm32-16/index.html">
<meta property="og:site_name" content="ZiTe 本物志">
<meta property="og:description" content="前言看門狗計時器（Watchdog timer，WDG）是眾多 MCU 都有的功能，它是一種特殊功能的計時器，其功能爲不斷下數，如果下數到一個值之前都沒有做刷新（Refresh）的話就認定目前系統出問題了（例如進入死迴圈跳不出來），並自動觸發系統重置（System reset）。如果要系統正常運作不 Reset 的話，必須要在 WDG Timeout 前進行 Refresh，以告訴 WDG：「我還">
<meta property="og:locale" content="zh_TW">
<meta property="og:image" content="https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEiAyWPGZfScHMRKg2AUp4-syulcKDCuEWl1GgOjWdlEewFwb8sI7TwdQnd3AvPH_jOHXyKoPmhDB4VOGnV4SdU_4nfIKoMnLwsg4NK4zleMNhzSIhdjbStZmpoSRM4kH3uUoXv8j-K6TZkexnCzSneRWWuxdRodgVEUK_oHwVDBT7WDsmDpEFmm1ma4/s16000/ezgif.com-gif-maker.gif">
<meta property="article:published_time" content="2022-09-29T04:00:00.000Z">
<meta property="article:modified_time" content="2024-06-22T08:56:19.894Z">
<meta property="article:author" content="ZiTe">
<meta property="article:tag" content="教學">
<meta property="article:tag" content="STM32">
<meta property="article:tag" content="LibOpenCM3">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEiAyWPGZfScHMRKg2AUp4-syulcKDCuEWl1GgOjWdlEewFwb8sI7TwdQnd3AvPH_jOHXyKoPmhDB4VOGnV4SdU_4nfIKoMnLwsg4NK4zleMNhzSIhdjbStZmpoSRM4kH3uUoXv8j-K6TZkexnCzSneRWWuxdRodgVEUK_oHwVDBT7WDsmDpEFmm1ma4/s16000/ezgif.com-gif-maker.gif">


<link rel="canonical" href="https://ziteh.github.io/posts/libopencm3-stm32-16/">



<script class="next-config" data-name="page" type="application/json">{"sidebar":"","isHome":false,"isPost":true,"lang":"zh-TW","comments":true,"permalink":"https://ziteh.github.io/posts/libopencm3-stm32-16/","path":"posts/libopencm3-stm32-16/","title":"STM32 LibOpenCM3：IWDG 獨立看門狗計時器"}</script>

<script class="next-config" data-name="calendar" type="application/json">""</script>
<title>STM32 LibOpenCM3：IWDG 獨立看門狗計時器 | ZiTe 本物志</title>
  








  <noscript>
    <link rel="stylesheet" href="/css/noscript.css">
  </noscript>
</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="headband"></div>

  <main class="main">
    <div class="column">
      <header class="header" itemscope itemtype="http://schema.org/WPHeader"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切換導航欄" role="button">
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <i class="logo-line"></i>
      <p class="site-title">ZiTe 本物志</p>
      <i class="logo-line"></i>
      <p class="site-subtitle" itemprop="description">一位慢步於程式、電路與文學之人的學習記錄與分享</p>
    </a>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger" aria-label="搜尋" role="button">
    </div>
  </div>
</div>



<nav class="site-nav">
  <ul class="main-menu menu"><li class="menu-item menu-item-tags"><a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>標籤</a></li><li class="menu-item menu-item-categories"><a href="/categories/" rel="section"><i class="fa fa-folder-open fa-fw"></i>分類</a></li><li class="menu-item menu-item-archives"><a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>歸檔</a></li>
  </ul>
</nav>




</header>
        
  
  <aside class="sidebar">

    <div class="sidebar-inner sidebar-nav-active sidebar-toc-active">
      

      <div class="sidebar-panel-container">
        <!--noindex-->
        <div class="post-toc-wrap sidebar-panel">
            <div class="post-toc animated"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#%E5%89%8D%E8%A8%80"><span class="nav-text">前言</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E6%AD%A3%E6%96%87"><span class="nav-text">正文</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%AE%8C%E6%95%B4%E7%A8%8B%E5%BC%8F"><span class="nav-text">完整程式</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%88%86%E6%AE%B5%E8%AA%AA%E6%98%8E"><span class="nav-text">分段說明</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#include"><span class="nav-text">Include</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#rcc"><span class="nav-text">RCC</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#iwdg-%E8%A8%AD%E5%AE%9A"><span class="nav-text">IWDG 設定</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E4%B8%BB%E7%A8%8B%E5%BC%8F"><span class="nav-text">主程式</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%A4%9A%E7%92%B0%E5%A2%83%E7%A8%8B%E5%BC%8F%EF%BC%88f446re-f103rb%EF%BC%89"><span class="nav-text">多環境程式（F446RE + F103RB）</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%88%90%E6%9E%9C"><span class="nav-text">成果</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E5%B0%8F%E7%B5%90"><span class="nav-text">小結</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E5%8F%83%E8%80%83%E8%B3%87%E6%96%99"><span class="nav-text">參考資料</span></a></li></ol></div>
        </div>
        <!--/noindex-->

        <div class="site-overview-wrap sidebar-panel">
          <div class="site-author animated" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <a href="/about/" title="About">
      <img class="site-author-image" itemprop="image" alt="ZiTe"
        src="/uploads/avatar.png">
    <p class="site-author-name" itemprop="name">ZiTe</p>
    <div class="site-description" itemprop="description"></div>
  </a>
</div>
  <div class="links-of-author animated">
      <span class="links-of-author-item">
        <a href="https://github.com/ziteh" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;ziteh" rel="noopener me" target="_blank"><i class="fab fa-github fa-fw"></i></a>
      </span>
      <span class="links-of-author-item">
        <a href="https://www.youtube.com/@siderakb" title="YouTube → https:&#x2F;&#x2F;www.youtube.com&#x2F;@siderakb" rel="noopener me" target="_blank"><i class="fab fa-youtube fa-fw"></i></a>
      </span>
      <span class="links-of-author-item">
        <a href="https://siderakb.github.io/" title="SideraKB → https:&#x2F;&#x2F;siderakb.github.io&#x2F;" rel="noopener me" target="_blank"><i class="fa fa-keyboard fa-fw"></i></a>
      </span>
      <span class="links-of-author-item">
        <a href="mailto:honmonoh@gmail.com" title="E-Mail → mailto:honmonoh@gmail.com" rel="noopener me" target="_blank"><i class="fa fa-envelope fa-fw"></i></a>
      </span>
  </div>

        </div>
      </div>
        <div class="back-to-top animated" role="button" aria-label="回到頂端">
          <i class="fa fa-arrow-up"></i>
          <span>0%</span>
        </div>
    </div>

    
  </aside>


    </div>

    <div class="main-inner post posts-expand">


  


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="zh-TW">
    <link itemprop="mainEntityOfPage" href="https://ziteh.github.io/posts/libopencm3-stm32-16/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/uploads/avatar.png">
      <meta itemprop="name" content="ZiTe">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="ZiTe 本物志">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="STM32 LibOpenCM3：IWDG 獨立看門狗計時器 | ZiTe 本物志">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
          
          <div class="post-tags">
              <a href="/tags/%E6%95%99%E5%AD%B8/" rel="tag"> 教學</a>
              <a href="/tags/STM32/" rel="tag"> STM32</a>
              <a href="/tags/LibOpenCM3/" rel="tag"> LibOpenCM3</a>
          </div>

        <h1 class="post-title" itemprop="name headline">
          STM32 LibOpenCM3：IWDG 獨立看門狗計時器
        </h1>


        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E7%B0%A1%E5%96%AE%E5%85%A5%E9%96%80-LibOpenCM3-STM32-%E5%B5%8C%E5%85%A5%E5%BC%8F%E7%B3%BB%E7%B5%B1%E9%96%8B%E7%99%BC/" itemprop="url" rel="index"><span itemprop="name">簡單入門 LibOpenCM3 STM32 嵌入式系統開發</span></a>
        </span>
    </span>
    <span class="post-meta-item">
      
      

      <time title="創建時間：2022-09-29 12:00:00" itemprop="dateCreated datePublished" datetime="2022-09-29T12:00:00+08:00">2022-09-29</time>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody"><h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p>看門狗計時器（Watchdog timer，WDG）是眾多 MCU 都有的功能，它是一種特殊功能的計時器，其功能爲不斷下數，如果下數到一個值之前都沒有做刷新（Refresh）的話就認定目前系統出問題了（例如進入死迴圈跳不出來），並自動觸發系統重置（System reset）。如果要系統正常運作不 Reset 的話，必須要在 WDG Timeout 前進行 Refresh，以告訴 WDG：「我還在正常運作，不要把我 Reset 掉」。</p>
<span id="more"></span>

<p>STM32 中有兩種 WDG——獨立看門狗（Independent WDG，IWDG）、窗口看門狗（Window WDG，WWDG）。</p>
<p>IWDG 正如其名，是一個自己獨立的 WDG。它擁有的獨立時鐘源，因此不受 AHB、APB1 和 APB2 的影響。是一個雖然整合在一起，但是實際上完全獨立的功能模組。但由於它使用的是 LSI RC 震盪器作爲時鐘源，故時間精度較低。</p>
<p>WWDG 的特色就是它擁有時間窗口（Timing Window）的概念，必須要在指定的時間區段內進行 Refresh 才不會導致它觸發 Reset，太早太晚都不行，而這個時間區段就是 Window。</p>
<blockquote>
<p>The devices feature two embedded watchdog peripherals that offer a combination of high<br>safety level, timing accuracy and flexibility of use.</p>
<p>Both watchdog peripherals (Independent and Window) serve to detect and resolve malfunctions due to software failure, and to trigger system reset or an interrupt (window watchdog only) when the counter reaches a given timeout value.<br>– From RM0390</p>
</blockquote>
<p>本文將先以 IWDG 爲例，寫一個簡單的例子，以測試 IWDG 是否可以自動觸發 Reset。</p>
<h1 id="正文"><a href="#正文" class="headerlink" title="正文"></a>正文</h1><p>首先一樣以 Nucleo-F446RE 做示範。</p>
<p>首先<a href="https://ziteh.github.io/2022/09/libopencm3-stm32-2/#%E5%BB%BA%E7%AB%8B%E5%B0%88%E6%A1%88">建立一個 PIO 的專案</a>，選擇 Framework 爲「libopencm3」，並在 <code>src/</code> 資料夾中新增並開啓 <code>main.c</code> 檔案。</p>
<h2 id="完整程式"><a href="#完整程式" class="headerlink" title="完整程式"></a>完整程式</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * @file   main.c</span></span><br><span class="line"><span class="comment"> * @brief  IWDG (Independent watchdog) example for STM32 Nuclso-F446RE.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;libopencm3/stm32/rcc.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;libopencm3/stm32/gpio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;libopencm3/stm32/iwdg.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;libopencm3/cm3/systick.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;libopencm3/cm3/nvic.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> RCC_LED_GPIO (RCC_GPIOA)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> GPIO_LED_PORT (GPIOA)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> GPIO_LED_PIN (GPIO5) <span class="comment">/* D13. */</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="keyword">volatile</span> <span class="type">uint32_t</span> systick_delay = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="type">void</span> <span class="title function_">delay_ms</span><span class="params">(<span class="type">uint32_t</span> value)</span></span><br><span class="line">&#123;</span><br><span class="line">  systick_delay = value;</span><br><span class="line">  <span class="keyword">while</span> (systick_delay != <span class="number">0</span>)</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="comment">/* Wait. */</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="type">void</span> <span class="title function_">systick_setup</span><span class="params">(<span class="type">void</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">  systick_set_clocksource(STK_CSR_CLKSOURCE_AHB_DIV8);</span><br><span class="line">  systick_set_reload(rcc_ahb_frequency / <span class="number">8</span> / <span class="number">1000</span> - <span class="number">1</span>);</span><br><span class="line">  systick_interrupt_enable();</span><br><span class="line">  systick_counter_enable();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="type">void</span> <span class="title function_">rcc_setup</span><span class="params">(<span class="type">void</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">  rcc_clock_setup_pll(&amp;rcc_hse_8mhz_3v3[RCC_CLOCK_3V3_84MHZ]);</span><br><span class="line">  rcc_periph_clock_enable(RCC_LED_GPIO);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="type">void</span> <span class="title function_">iwdg_setup</span><span class="params">(<span class="type">void</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">  iwdg_reset();</span><br><span class="line">  iwdg_set_period_ms(<span class="number">300</span>);</span><br><span class="line">  iwdg_start();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="type">void</span> <span class="title function_">led_setup</span><span class="params">(<span class="type">void</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="comment">/* Set LED pin to output push-pull. */</span></span><br><span class="line">  gpio_mode_setup(GPIO_LED_PORT, GPIO_MODE_OUTPUT, GPIO_PUPD_NONE, GPIO_LED_PIN);</span><br><span class="line">  gpio_set_output_options(GPIO_LED_PORT, GPIO_OTYPE_PP, GPIO_OSPEED_2MHZ, GPIO_LED_PIN);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">(<span class="type">void</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">  rcc_setup();</span><br><span class="line">  systick_setup();</span><br><span class="line">  led_setup();</span><br><span class="line"></span><br><span class="line">  gpio_clear(GPIO_LED_PORT, GPIO_LED_PIN);</span><br><span class="line">  delay_ms(<span class="number">10</span>);</span><br><span class="line">  gpio_set(GPIO_LED_PORT, GPIO_LED_PIN);</span><br><span class="line">  delay_ms(<span class="number">2000</span>);</span><br><span class="line"></span><br><span class="line">  iwdg_setup(); <span class="comment">/* Setup and start IWDG. */</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">while</span> (<span class="number">1</span>)</span><br><span class="line">  &#123;</span><br><span class="line">    gpio_toggle(GPIO_LED_PORT, GPIO_LED_PIN); <span class="comment">/* LED on/off. */</span></span><br><span class="line">    delay_ms(<span class="number">200</span>);</span><br><span class="line">    iwdg_reset(); <span class="comment">/* Refresh. */</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * @brief  SysTick handler.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">sys_tick_handler</span><span class="params">(<span class="type">void</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="keyword">if</span> (systick_delay != <span class="number">0</span>)</span><br><span class="line">  &#123;</span><br><span class="line">    systick_delay--;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="分段說明"><a href="#分段說明" class="headerlink" title="分段說明"></a>分段說明</h2><h3 id="include"><a href="#include" class="headerlink" title="Include"></a>Include</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;libopencm3/stm32/rcc.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;libopencm3/stm32/gpio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;libopencm3/stm32/iwdg.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;libopencm3/cm3/systick.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;libopencm3/cm3/nvic.h&gt;</span></span></span><br></pre></td></tr></table></figure>
<p>爲了要更好地驗證 IWDG 的運作，所以我們要有較爲精確的 <code>delay()</code>，因此這裡我除了 <code>iwdg.h</code> 外還引入了 <code>systick.h</code> 與 <code>nvic.h</code>，利用 SysTick 來實現較精確的 ms 等級 <code>delay()</code>。</p>
<blockquote>
<p>SysTick 的用法請參考<a href="https://ziteh.github.io/2022/09/libopencm3-stm32-15/">之前的文章</a>。</p>
</blockquote>
<h3 id="rcc"><a href="#rcc" class="headerlink" title="RCC"></a>RCC</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">static</span> <span class="type">void</span> <span class="title function_">rcc_setup</span><span class="params">(<span class="type">void</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">  rcc_clock_setup_pll(&amp;rcc_hse_8mhz_3v3[RCC_CLOCK_3V3_84MHZ]);</span><br><span class="line">  rcc_periph_clock_enable(RCC_LED_GPIO);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>由於 IWDG 是完全獨立的，它不在 AHB、APB1 或 APB2 底下，所以 RCC 不用設定啓用 IWDG。</p>
<h3 id="iwdg-設定"><a href="#iwdg-設定" class="headerlink" title="IWDG 設定"></a>IWDG 設定</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">static</span> <span class="type">void</span> <span class="title function_">iwdg_setup</span><span class="params">(<span class="type">void</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">  iwdg_reset();</span><br><span class="line">  iwdg_set_period_ms(<span class="number">300</span>);</span><br><span class="line">  iwdg_start();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>這就是 IWDG 的設定部分，相當簡單，就是先重置它，然後設定 Timeout，最後再將它致能。</p>
<p>頻率那些的計算 LibOpenCM3 都直接實現在 <code>iwdg_set_period_ms()</code> 中了，其實際內容可以查看 <a target="_blank" rel="noopener" href="https://github.com/libopencm3/libopencm3/blob/44e142d4f97863e669737707a1a22bf40ed49bbc/lib/stm32/common/iwdg_common_all.c#L73-L114">LibOpenCM3 的 repo</a>。</p>
<h3 id="主程式"><a href="#主程式" class="headerlink" title="主程式"></a>主程式</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">(<span class="type">void</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">  rcc_setup();</span><br><span class="line">  systick_setup();</span><br><span class="line">  led_setup();</span><br><span class="line"></span><br><span class="line">  gpio_clear(GPIO_LED_PORT, GPIO_LED_PIN);</span><br><span class="line">  delay_ms(<span class="number">10</span>);</span><br><span class="line">  gpio_set(GPIO_LED_PORT, GPIO_LED_PIN);</span><br><span class="line">  delay_ms(<span class="number">2000</span>);</span><br><span class="line"></span><br><span class="line">  iwdg_setup(); <span class="comment">/* Setup and start IWDG. */</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">while</span> (<span class="number">1</span>)</span><br><span class="line">  &#123;</span><br><span class="line">    gpio_toggle(GPIO_LED_PORT, GPIO_LED_PIN); <span class="comment">/* LED on/off. */</span></span><br><span class="line">    delay_ms(<span class="number">200</span>);</span><br><span class="line">    iwdg_reset(); <span class="comment">/* Refresh. */</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>爲了要驗證 IWDG 的運作，我在啓動 IWDG（<code>iwdg_setup()</code>）前先讓 LED off 10ms，然後再 on 2s，以方便我們觀察是否進行了 System Reset。</p>
<p>啓動 IWDG 後進入主迴圈並讓 LED 閃爍。而這裡每次 delay 後都會 Refresh IWDG（<code>iwdg_reset()</code>）。由於目前的 IWDG timeout 設爲 300ms，而這裡每 200ms 就會進行 Refresh，所以 IWDG 不會觸發 Reset，MCU 可以一直運作下去。</p>
<p>但如果把 IWDG timeout 的 300ms 調短，或調慢主迴圈內的 200ms，讓系統來不及在 IWDG timeout 前 Refresh 的話，IWDG 就會自動觸發 Reset，這時觀察 LED 的話就會看到它一直在 off 10ms 後 on 2s，因爲 MCU 一直被 Reset。</p>
<h2 id="多環境程式（f446re-f103rb）"><a href="#多環境程式（f446re-f103rb）" class="headerlink" title="多環境程式（F446RE + F103RB）"></a>多環境程式（F446RE + F103RB）</h2><p>由於 STM32F1 的部分函式不同，所以 F103RB 沒辦法直接使用上面的 F446RE 的程式。</p>
<p>以下列出主要的差異部分。完整的程式請看 <a target="_blank" rel="noopener" href="https://github.com/ziteh/stm32-examples/tree/main/libopencm3/iwdg">GitHub repo</a>。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">static</span> <span class="type">void</span> <span class="title function_">rcc_setup</span><span class="params">(<span class="type">void</span>)</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="meta">#<span class="keyword">if</span> defined(STM32F1)</span></span><br><span class="line">  rcc_clock_setup_in_hse_8mhz_out_72mhz();</span><br><span class="line"><span class="meta">#<span class="keyword">elif</span> defined(STM32F4)</span></span><br><span class="line">  rcc_clock_setup_pll(&amp;rcc_hse_8mhz_3v3[RCC_CLOCK_3V3_84MHZ]);</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"></span><br><span class="line">  rcc_periph_clock_enable(RCC_LED_GPIO);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">static</span> <span class="type">void</span> <span class="title function_">led_setup</span><span class="params">(<span class="type">void</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="comment">/* Set LED pin to output push-pull. */</span></span><br><span class="line"><span class="meta">#<span class="keyword">if</span> defined(STM32F1)</span></span><br><span class="line">  gpio_set_mode(GPIO_LED_PORT, GPIO_MODE_OUTPUT_2_MHZ, GPIO_CNF_OUTPUT_PUSHPULL, GPIO_LED_PIN);</span><br><span class="line"><span class="meta">#<span class="keyword">else</span></span></span><br><span class="line">  gpio_mode_setup(GPIO_LED_PORT, GPIO_MODE_OUTPUT, GPIO_PUPD_NONE, GPIO_LED_PIN);</span><br><span class="line">  gpio_set_output_options(GPIO_LED_PORT, GPIO_OTYPE_PP, GPIO_OSPEED_2MHZ, GPIO_LED_PIN);</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="成果"><a href="#成果" class="headerlink" title="成果"></a>成果</h2><p>我分別用了兩塊 STM32，並將左邊的 IWDG timeout 設爲 300 ms，右邊的爲 100 ms，而主迴圈的 Refresh 前 delay 都是 200 ms。</p>
<p>可以看到左邊的 STM32 可以一直運作，而右邊的因爲來不及 Refresh 所以一直在 Reset。</p>
<p><img src="https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEiAyWPGZfScHMRKg2AUp4-syulcKDCuEWl1GgOjWdlEewFwb8sI7TwdQnd3AvPH_jOHXyKoPmhDB4VOGnV4SdU_4nfIKoMnLwsg4NK4zleMNhzSIhdjbStZmpoSRM4kH3uUoXv8j-K6TZkexnCzSneRWWuxdRodgVEUK_oHwVDBT7WDsmDpEFmm1ma4/s16000/ezgif.com-gif-maker.gif"></p>
<h1 id="小結"><a href="#小結" class="headerlink" title="小結"></a>小結</h1><p>WDG 在簡單的非正式專案中可能不太會用到，但它設定簡單、使用方便，稍微瞭解一下也很值得。</p>
<h1 id="參考資料"><a href="#參考資料" class="headerlink" title="參考資料"></a>參考資料</h1><ul>
<li><a target="_blank" rel="noopener" href="https://github.com/libopencm3/libopencm3-examples">libopencm3&#x2F;libopencm3-examples</a></li>
<li><a target="_blank" rel="noopener" href="https://github.com/platformio/platform-ststm32">platformio&#x2F;platform-ststm32</a></li>
<li><a target="_blank" rel="noopener" href="https://www.st.com/resource/en/datasheet/stm32f446re.pdf">STM32F446RE datasheet (DS10693)</a></li>
<li><a target="_blank" rel="noopener" href="https://www.st.com/resource/en/reference_manual/rm0390-stm32f446xx-advanced-armbased-32bit-mcus-stmicroelectronics.pdf">STM32F446xx reference manual (RM0390)</a></li>
<li><a target="_blank" rel="noopener" href="https://www.st.com/resource/en/datasheet/stm32f103rb.pdf">STM32F103RB datasheet (DS5319)</a></li>
<li><a target="_blank" rel="noopener" href="https://www.st.com/resource/en/user_manual/um1724-stm32-nucleo64-boards-mb1136-stmicroelectronics.pdf">STM32 Nucleo-64 board user manual (UM1724)</a></li>
</ul>
<blockquote>
<p>本文的程式也有放在 <a target="_blank" rel="noopener" href="https://github.com/ziteh/stm32-examples/tree/main/libopencm3/iwdg">GitHub</a> 上。<br>本文同步發表於<a target="_blank" rel="noopener" href="https://ithelp.ithome.com.tw/articles/10299443"> iT 邦幫忙-2022 iThome 鐵人賽</a>。</p>
</blockquote>

    </div>

    
    
    

    <footer class="post-footer">

        

          <div class="post-nav">
            <div class="post-nav-item">
                <a href="/posts/libopencm3-stm32-15/" rel="prev" title="STM32 LibOpenCM3：SysTick delay">
                  <i class="fa fa-angle-left"></i> STM32 LibOpenCM3：SysTick delay
                </a>
            </div>
            <div class="post-nav-item">
                <a href="/posts/libopencm3-stm32-17/" rel="next" title="STM32 WWDG 窗口看門狗計時器">
                  STM32 WWDG 窗口看門狗計時器 <i class="fa fa-angle-right"></i>
                </a>
            </div>
          </div>
    </footer>
  </article>
</div>







  <p style="text-align: center;color: #a3a3a3;font-size: 14px;margin-top: 60px;">留言可能不會立即顯示。若過了幾天仍未出現，請 <a href="mailto:honmonoh@gmail.com">Email</a> 聯繫：）</p>
    
  <div class="comments" id="disqus_thread">
    <noscript>Please enable JavaScript to view the comments powered by Disqus.</noscript>
  </div>
  
</div>
  </main>

  <footer class="footer">
    <div class="footer-inner">

  <div class="copyright">
    <a target="_blank" rel="noopener" href="https://creativecommons.org/licenses/by-nc-nd/4.0/" title="本網站所有內容除特別聲明外，均採用創用CC 姓名標示-非商業性-禁止改作授權。
    分享時請註明作者及出處。" style="border-bottom: 0;">
      <img src="https://i.creativecommons.org/l/by-nc-nd/3.0/80x15.png" style="display: unset;">
    </a>
    &copy; 
    <span itemprop="copyrightYear">2024</span>
    <span class="with-love">
      <i class="fa fa-heart"></i>
    </span>
    <span class="author" itemprop="copyrightHolder">ZiTe</span>
  </div>
  <div class="powered-by">Powered by <a href="https://hexo.io/" rel="noopener" target="_blank">Hexo</a> & <a href="https://theme-next.js.org/pisces/" rel="noopener" target="_blank">NexT.Pisces</a>
  </div>

    </div>
  </footer>

  
  <div class="toggle sidebar-toggle" role="button">
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
  </div>
  <div class="sidebar-dimmer"></div>

<noscript>
  <div class="noscript-warning">Theme NexT works best with JavaScript enabled</div>
</noscript>


  
  <script src="https://cdnjs.cloudflare.com/ajax/libs/animejs/3.2.1/anime.min.js" integrity="sha256-XL2inqUJaslATFnHdJOi9GfQ60on8Wx1C2H8DYiN1xY=" crossorigin="anonymous"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/fancyapps-ui/5.0.31/fancybox/fancybox.umd.js" integrity="sha256-a+H7FYzJv6oU2hfsfDGM2Ohw/cR9v+hPfxHCLdmCrE8=" crossorigin="anonymous"></script>
<script src="/js/comments.js"></script><script src="/js/utils.js"></script><script src="/js/sidebar.js"></script><script src="/js/next-boot.js"></script>

  



  <script src="/js/third-party/fancybox.js"></script>



  




  

  <script class="next-config" data-name="enableMath" type="application/json">false</script><script class="next-config" data-name="mathjax" type="application/json">{"enable":true,"tags":"none","js":{"url":"https://cdnjs.cloudflare.com/ajax/libs/mathjax/3.2.2/es5/tex-mml-chtml.js","integrity":"sha256-MASABpB4tYktI2Oitl4t+78w/lyA+D7b/s9GEP0JOGI="}}</script>
<script src="/js/third-party/math/mathjax.js"></script>


<script class="next-config" data-name="disqus" type="application/json">{"enable":true,"shortname":"zite-honmonoh","count":false,"i18n":{"disqus":"disqus"}}</script>
<script src="/js/third-party/comments/disqus.js"></script>

</body>
</html>
